<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singe's Token Command Center</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #e94560;
            margin-bottom: 30px;
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p { color: #a0a0a0; font-size: 1.1em; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            backdrop-filter: blur(10px);
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.2);
        }
        .stat-card h3 { color: #e94560; font-size: 0.85em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 2.2em; font-weight: bold; }
        .stat-card .sub { color: #888; font-size: 0.85em; margin-top: 8px; }
        .stat-card .savings { color: #2ecc71; font-size: 0.9em; margin-top: 5px; }
        .section {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .section h2 {
            color: #e94560;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }
        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { 
            color: #888; 
            font-weight: 600; 
            font-size: 0.8em; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover { background: rgba(255,255,255,0.02); }
        .model-select {
            background: #0f3460;
            color: #fff;
            border: 1px solid rgba(233, 69, 96, 0.5);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        .model-select:hover { border-color: #e94560; }
        .model-select:focus { outline: 2px solid #e94560; }
        .model-select.changed { border-color: #f39c12; background: rgba(243, 156, 18, 0.1); }
        .cost-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .cost-low { background: #2ecc71; color: #000; }
        .cost-med { background: #f39c12; color: #000; }
        .cost-high { background: #e74c3c; color: #fff; }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .status-error { background: #e74c3c; box-shadow: 0 0 8px #e74c3c; }
        .status-disabled { background: #888; }
        .btn {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn:hover { transform: scale(1.02); box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 52, 96, 0.98);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            backdrop-filter: blur(20px);
            border-top: 2px solid #e94560;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .save-bar.visible { transform: translateY(0); }
        .save-bar span { font-weight: 600; font-size: 1.1em; }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-card {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .comparison-card.active { 
            border-color: #2ecc71; 
            background: rgba(46, 204, 113, 0.05);
        }
        .comparison-card h4 { color: #888; margin-bottom: 10px; font-size: 0.9em; }
        .comparison-card .price { font-size: 2em; font-weight: bold; }
        .comparison-card .detail { color: #aaa; margin-top: 8px; font-size: 0.9em; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: auto;
            transition: all 0.2s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); }
        .error-banner {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error-banner.visible { display: block; }
        .success-banner {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .success-banner.visible { display: block; }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .comparison { grid-template-columns: 1fr; }
            table { font-size: 0.8em; }
            th, td { padding: 10px 6px; }
            .header h1 { font-size: 1.8em; }
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444;
            transition: .4s;
            border-radius: 26px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêí Singe's Token Command Center</h1>
        <p>Monitor, manage, and optimize AI model usage across all agents</p>
    </div>

    <div class="error-banner" id="errorBanner">
        ‚ùå <span id="errorText"></span>
    </div>
    <div class="success-banner" id="successBanner">
        ‚úÖ <span id="successText"></span>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>üí∞ Today's Spend</h3>
            <div class="value" id="todaySpend">$<span class="loading"></span></div>
            <div class="sub" id="tokenCount">Loading...</div>
        </div>
        <div class="stat-card">
            <h3>üìä Est. Daily Cost</h3>
            <div class="value" id="dailyCost">$<span class="loading"></span></div>
            <div class="savings" id="savingsText">Loading savings...</div>
        </div>
        <div class="stat-card">
            <h3>ü§ñ Active Agents</h3>
            <div class="value" id="agentCount"><span class="loading"></span></div>
            <div class="sub">Sub-agents + main</div>
        </div>
        <div class="stat-card">
            <h3>‚è∞ Cron Jobs</h3>
            <div class="value" id="cronCount"><span class="loading"></span></div>
            <div class="sub" id="cronEnabled">Loading...</div>
        </div>
    </div>

    <div class="section">
        <h2>üìà Cost Comparison</h2>
        <div class="comparison">
            <div class="comparison-card active" id="currentCard">
                <h4>‚úÖ Current Configuration</h4>
                <div class="price" id="currentCost">$<span class="loading"></span>/day</div>
                <div class="detail" id="currentDetail">Mixed: Qwen for crons, Kimi for main</div>
            </div>
            <div class="comparison-card" id="optimizedCard">
                <h4>üíé All Premium (Reference)</h4>
                <div class="price">~$8.50/day</div>
                <div class="detail">If everything used Opus/Sonnet</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ü§ñ AGENTS <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button></h2>
        <table>
            <thead>
                <tr>
                    <th>Agent</th>
                    <th>Role</th>
                    <th>Current Model</th>
                    <th>Cost/M tokens</th>
                    <th>Change Model</th>
                </tr>
            </thead>
            <tbody id="agentsTable">
                <tr><td colspan="5" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading agents...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>‚è∞ CRON JOBS</h2>
        <table>
            <thead>
                <tr>
                    <th>Job Name</th>
                    <th>Status</th>
                    <th>Schedule</th>
                    <th>Current Model</th>
                    <th>Est. Daily Cost</th>
                    <th>Change Model</th>
                </tr>
            </thead>
            <tbody id="cronsTable">
                <tr><td colspan="6" style="text-align: center; padding: 40px;"><span class="loading"></span> Loading cron jobs...</td></tr>
            </tbody>
        </table>
    </div>

    <div style="height: 100px;"></div>

    <div class="save-bar" id="saveBar">
        <span>‚ö° <span id="changeCount">0</span> unsaved changes!</span>
        <button class="btn" onclick="saveChanges()">üíæ Save & Apply</button>
        <button class="btn btn-secondary" onclick="discardChanges()">‚ùå Discard</button>
    </div>

    <script>
        const API_BASE = '/.netlify/functions';
        let changes = {};
        let models = {};
        let agents = [];
        let crons = [];

        async function loadData() {
            try {
                showLoading();
                
                // Load all data in parallel
                const [modelsRes, agentsRes, cronsRes, statsRes, summaryRes] = await Promise.all([
                    fetch(`${API_BASE}/api/models`),
                    fetch(`${API_BASE}/api/agents`),
                    fetch(`${API_BASE}/api/crons`),
                    fetch(`${API_BASE}/api/stats`),
                    fetch(`${API_BASE}/api/summary`)
                ]);

                models = await modelsRes.json();
                agents = await agentsRes.json();
                crons = await cronsRes.json();
                const stats = await statsRes.json();
                const summary = await summaryRes.json();

                renderStats(stats, summary);
                renderAgents();
                renderCrons();
                
            } catch (err) {
                showError('Failed to load data: ' + err.message);
            }
        }

        function showLoading() {
            document.getElementById('todaySpend').innerHTML = '$<span class="loading"></span>';
            document.getElementById('dailyCost').innerHTML = '$<span class="loading"></span>';
        }

        function renderStats(stats, summary) {
            document.getElementById('todaySpend').textContent = `$${stats.today.total_cost.toFixed(2)}`;
            document.getElementById('tokenCount').textContent = `${stats.today.total_tokens.toLocaleString()} tokens today`;
            document.getElementById('dailyCost').textContent = `$${summary.estimated_daily_cost.toFixed(2)}`;
            document.getElementById('savingsText').textContent = `üíö Saving ~${Math.round((1 - summary.estimated_daily_cost/8.5) * 100)}% vs all-premium`;
            document.getElementById('agentCount').textContent = summary.agents_count;
            document.getElementById('cronCount').textContent = summary.crons_count;
            document.getElementById('cronEnabled').textContent = `${summary.enabled_crons} enabled`;
            document.getElementById('currentCost').innerHTML = `$${summary.estimated_daily_cost.toFixed(2)}/day`;
            document.getElementById('currentDetail').textContent = `${summary.using_qwen} jobs on Qwen, ${summary.using_premium} on premium`;
            document.getElementById('changeCount').textContent = Object.keys(changes).length;
        }

        function renderAgents() {
            const tbody = document.getElementById('agentsTable');
            tbody.innerHTML = agents.map(agent => {
                const costBadge = `<span class="cost-badge cost-${agent.tier}">$${agent.cost_input}/$${agent.cost_output}</span>`;
                
                return `
                    <tr data-type="agent" data-id="${agent.id}">
                        <td><strong>${agent.name}</strong></td>
                        <td>${agent.role}</td>
                        <td>${agent.model_name}</td>
                        <td>${costBadge}</td>
                        <td>
                            <select class="model-select" onchange="onModelChange('agent', '${agent.id}', this.value)">
                                ${Object.entries(models).map(([key, info]) => 
                                    `<option value="${key}" ${agent.model === key ? 'selected' : ''}>${info.name}</option>`
                                ).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderCrons() {
            const tbody = document.getElementById('cronsTable');
            tbody.innerHTML = crons.map(cron => {
                const costBadge = `<span class="cost-badge cost-${cron.tier}">$${cron.daily_cost.toFixed(3)}/day</span>`;
                const statusClass = cron.enabled ? 'status-ok' : 'status-disabled';
                const statusText = cron.enabled ? 'Enabled' : 'Disabled';
                
                return `
                    <tr data-type="cron" data-id="${cron.id}">
                        <td><strong>${cron.name}</strong></td>
                        <td><span class="status-dot ${statusClass}"></span>${statusText}</td>
                        <td>${cron.schedule}</td>
                        <td>${cron.model_name}</td>
                        <td>${costBadge}</td>
                        <td>
                            <select class="model-select" onchange="onModelChange('cron', '${cron.id}', this.value)">
                                <option value="default" ${cron.model === 'default' ? 'selected' : ''}>Default (kimi-k2.5)</option>
                                ${Object.entries(models).map(([key, info]) => 
                                    `<option value="${key}" ${cron.model === key ? 'selected' : ''}>${info.name}</option>`
                                ).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function onModelChange(type, id, newModel) {
            changes[`${type}:${id}`] = { type, id, model: newModel };
            document.getElementById('saveBar').classList.add('visible');
            document.getElementById('changeCount').textContent = Object.keys(changes).length;
            
            // Visual feedback
            const select = document.querySelector(`tr[data-type="${type}"][data-id="${id}"] select`);
            select.classList.add('changed');
        }

        async function saveChanges() {
            const btn = document.querySelector('#saveBar .btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'üíæ Saving...';

            try {
                const promises = Object.values(changes).map(async change => {
                    const endpoint = change.type === 'agent' 
                        ? `/api/agents/${change.id}/model`
                        : `/api/crons/${change.id}/model`;
                    
                    const res = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: change.model })
                    });
                    
                    if (!res.ok) throw new Error(`Failed to update ${change.id}`);
                    return res.json();
                });

                await Promise.all(promises);
                
                // Restart gateway
                btn.textContent = 'üîÑ Restarting gateway...';
                const restartRes = await fetch(`${API_BASE}/api/restart`, { method: 'POST' });
                const restartData = await restartRes.json();
                
                changes = {};
                document.getElementById('saveBar').classList.remove('visible');
                
                showSuccess('‚úÖ Changes saved and gateway restarted!');
                
                // Reload data
                setTimeout(loadData, 2000);
                
            } catch (err) {
                showError('Error saving: ' + err.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function discardChanges() {
            changes = {};
            document.getElementById('saveBar').classList.remove('visible');
            loadData(); // Reload to reset selects
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorBanner').classList.add('visible');
            setTimeout(() => document.getElementById('errorBanner').classList.remove('visible'), 5000);
        }

        function showSuccess(msg) {
            document.getElementById('successText').textContent = msg;
            document.getElementById('successBanner').classList.add('visible');
            setTimeout(() => document.getElementById('successBanner').classList.remove('visible'), 5000);
        }

        // Initialize
        loadData();
        setInterval(loadData, 60000); // Refresh every minute
    </script>
</body>
</html>